# VaultServer CRD

Vault operator will deploy vault according to `VaultServer` CRD specification.

```yaml
apiVersion: "core.kubevault.com/v1alpha1"
kind: "VaultServer"
metadata:
  name: <name>
spec:
  ...
status:
  ...
```
### VaultServer Spec

VaultServer Spec contains the configuration about how to deploy vault in kubernetes cluster. 
```yaml
apiVersion: "core.kubevault.com/v1alpha1"
kind: "VaultServer"
metadata:
  name: <name>
spec:
  nodes: <num_of_nodes>
  baseImage: <base_image>
  version: <version>
  podPolicy:
    ...
  configMapName:
    ...
  backendStorage:
    ...
  unsealer:
    ...
```

- **nodes** (int): Number of vault nodes to deploy. For example, if `nodes:3`, then 3 vault server will be deployed in kubernetes cluster.

- **baseImage** (string): Base image to use for vault deployment. For example, `baseImage: vault`

- **version** (string): Version of vault image to be deployed. For example,
    ```yaml
    spec:
      baseImage: "vault"
      version: "0.10.0"
    ```
    here, `vault:0.10.0` image will be used to deploy vault.

- **podPolicy** (PodPolicy): PodPolicy defines the policy for pods. It contains resource requirements for the containers. For more information on `resources` see [here](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.10/#resourcerequirements-v1-core).
  ```yaml
  spec:
    podPolicy:
      resources:
        requests:
          cpu: "500m"
          memory: "1Gi"
   ```

- **configMapName** (string): Name of the configMap containing extra vault configuration. The configuration in the configMap will be **appended** to vault config generated by vault operator.
  ```yaml
  spec:
    configMapName: "vault-extra-config"
  ```
  configMap example:
  ```yaml
  apiVersion: v1
  data:
    vault.hcl: |
      telemetry {
      statsite_address = "statsite.company.local:8125"
      }
      ui = true
  kind: ConfigMap
  metadata:
    name: vault-extra-config
  ```

- **backendStorage** (BackendStorageSpec): It contains backend storage configuration for vault. See [here](vaultserver.md#backendstorage-spec) for more information.

- **unsealer** (UnsealerSpec): It contains auto unsealing configuration. See [here](vaultserver.md#unsealer-spec) for more information.

### BackendStorage Spec

BackendStorage Spec contains the information for vault storage backend. Vault operator generates storage configuration according to this spec.

#### inmem

To use In-Memory as storage backend in vault. For more information see [here](https://www.vaultproject.io/docs/configuration/storage/in-memory.html).
```yaml
backendStorage:
  inmem: true
```

#### etcd 

Contain the information to use etcd as storage backend in vault.
```yaml
backendStorage:
  etcd:
    address: "http://example.etcd.svc:8200"
    etcdApi: "v3"
```
**EtcdSpec** contain following fields: 
  - **address** (string): Specifies the addresses of the etcd instances. For vault documentation, click [here](https://www.vaultproject.io/docs/configuration/storage/etcd.html#address).
  - **etcdApi** (string): Specifies the version of the API to communicate with etcd. For vault documentation, click [here](https://www.vaultproject.io/docs/configuration/storage/etcd.html#etcd_api).
  - **haEnable** (bool): Specifies if high availability should be enabled. For vault documentation, click [here](https://www.vaultproject.io/docs/configuration/storage/etcd.html#ha_enabled).
  - **path** (string):Specifies the path in etcd where vault data will be stored. For vault documentation, click [here](https://www.vaultproject.io/docs/configuration/storage/etcd.html#path).
  - **sync** (bool):Specifies whether to sync list of available etcd services on startup. For vault documentation, click [here](https://www.vaultproject.io/docs/configuration/storage/etcd.html#sync).
  - **discoverySrv** (string): Specifies the domain name to query for SRV records describing cluster endpoints. For vault documentation, click [here](https://www.vaultproject.io/docs/configuration/storage/etcd.html#discovery_srv).
  - **credentialSecretName** (string): Specifies the secret name that contain username and password to use when authenticating with the etcd server. For vault documentation, click [here](https://www.vaultproject.io/docs/configuration/storage/etcd.html#username).
  
    ```yaml
    backendStorage:
      etcd:
        credentialSecretName: "vault-etcd-credential"
        ...
    ```
    Credential secret example:

    ```yaml
    apiVersion: v1
    data:
      username: <username>
      password: <password>
    kind: Secret
    metadata:
      name: vault-etcd-credential
    ```
    
  - **tlsSecretName** (string): Specifies the secret name that containsca cert, client cert and client key for etcd communication.For vaultdocumentation, click [here(https://www.vaultproject.io/docs/configuration/storage/etcdhtml#tls_ca_file).
  
    ```yaml
    backendStorage:
      etcd:
        tlsSecretName: "vault-etcd-tls"
        ...
    ```
    TLS secret example:

    ```yaml
    apiVersion: v1
    data:
      etcd-ca.crt: <ca_crt>
      etcd-client.crt: <client-crt>
      etcd-client.key: <client-key>
    kind: Secret
    metadata:
      name: vault-etcd-tls
    ```
#### gcs 

Contain the informations to use gcs as backend storage in vault. Vault documention about gcs storage can be found [here](https://www.vaultproject.io/docs/configuration/storage/google-cloud-storage.html)
```yaml
backendStorage:
  gcs:
    Bucket: <bucket_name>
    chunkSize: <chunk_size>
    maxParallel: <max_parallet>
    haEnabled: <true/false>
    credentialSecret: <secret_name>
```
**GcsSpec** has following fields:
  - **bucket** (string): Specifies the name of the bucket to use for storage.
  - **chunkSize** (string) : Specifies the maximum size (in kilobytes)to send in a single request. If set to 0, it will attempt to send the whole object at once, but will not retry any failures.
  - **maParallel** (int): Specifies the maximum number of paralleloperations to take place.
  - **haEnabled** (bool) : Specifies if high availability mode is enabled.
  - **credentialSecret** (string): Specifies the secret name containing google credential. If this is empty, then instance service account will be used. Google credential secret example:
    ```yaml
    apiVersion: v1
    data:
      sa.json: <data>
    kind: Secret
    metadata:
      name: google-credential
    ```

#### s3

Contain the information to use aws s3 as backend storage in vault. Vault documention about s3 storage can be found [here](https://www.vaultproject.io/docs/configuration/storage/s3.html).
  ```yaml
  backendStorage:
    s3:
      bucket: <bucket_name>
      endPoint: <end_point>
      region: <region>
      credentialSecret: <credential_secret_name>
      sessionTokenSecret: <session_secret_name>
      maxParallel: <max_parallel>
      s3ForcePathStyle: <true/false>
      disableSSL: <true/false>
  ```
  
  **S3Spec** has following fields:
  - **bucket** (string): Specifies the name of the bucket to use for storage.
  - **endPoint** (string): Specifies an alternative, AWS compatible, S3 endpoint.
  - **region** (string): Specifies the AWS region.
  - **credentialSecret** (string): Name of the secret containing AWS access key and secret key. Credential secret example:
    ```yaml
    apiVersion: v1
    data:
      access_key: <base64_encoded_access_key>
      secret_key: <base64_encoded_secret_key>
    kind: Secret
    metadata:
      name: aws-credential
      namespaces: default
    ```
  - **sessionTokenSecret** (string): Name of the secret containing AWS session token. Session token secret example:
    ```yaml
    apiVersion: v1
    data:
      session_token: <base64_encoded_session_token>
    kind: Secret
    metadata:
      name: aws-session
      namespaces: default
    ```
  - **maxParallel** (int):  Specifies the maximum number of concurrent requests to S3.
  - **s3ForcePathStyle** (bool): Specifies whether to use host bucket style domains with the configured endpoint. Default value is `false`.
  - **disableSSL** (bool):  Specifies if SSL should be used for the endpoint connection. Default value is `false`.

#### azure

Contain the information to use azure storage container as backend storage in vault. Vault documention about azure storage can be found [here](https://www.vaultproject.io/docs/configuration/storage/azure.html).
  ```yaml
  backendStorage:
    azure:
      accountName: <storage_account_name>
      accountKey: <storage_account_key>
      container: <container_name>
      maxParallel: <max_parallel>
  ```

  **AzureSpec** has following fields:
  - **accountName** (string): Specifies the Azure Storage account name.
  - **accountKey** (string): Specifies the Azure Storage account key.
  - **container** (string): Specifies the Azure Storage Blob container name.
  - **maxParallel** (int): Specifies the maximum number of concurrent operations to take place.


### Unsealer Spec

Vault operator use [kubevault/unsealer](https://github.com/kubevault/unsealer) to unseal vault. Unsealer spec contains the informations that used in unsealer to unseal vault.

```yaml
spec:
  unsealer:
    secretShares: <num_of_secret_shares>
    secretThresold: <num_of_secret_threshold>
    retryPeriodSeconds: <retry_period>
    overwriteExisting: <true/false>
    insecureTLS: <true/false>
    vaultCASecret: <secret_name>
    mode:
      ...
```

- **secretShares** (int): Specifies the number of shares to split the master key into.

- **secretThreshold** (int): Specifies the number of keys required to unseal vault.

- **retryPeriodSeconds** (int): How often to attempt to unseal the vault instance.

- **overwriteExisting** (bool): To overwrite existing unseal keys and root token.

- **insecureTLS** (bool): To skip tls verification when unsealer communicating with vault server.

- **vaultCASecret** (string): Name of secret containing ca cert that will be used to verify vault server certificates when unsealer communication with it.
  ```yaml
  spec:
    unsealer:
      vaultCASecret: vault-ca-secret
      ...
  ```
  Vault ca secret example:
  ```yaml
  apiVersion: v1
  data:
    ca.crt: <ca crt>
  kind: Secret
  metadata:
    name: vault-ca-secret
  ```
- **mode**: Mode contains unseal mechanism. Currently available mechanism are:
  - **kubernetesSecret** : Unseal key and root token are stored in kubernetes secret. This secret is created by unsealer.
    ```yaml
    spec:
      unsealer:
        ...
        mode:
          kubernetesSecret:
            secretName: <secret_name>
    ```
    kubernetesSecret contains following fields:
      - **secretName** (string): Unsealer will create secret of this name.
  <br></br>
  - **googleKmsGcs** : Unseal key and root token are stored in google cloud bucket and they are encrypted using google cryptographic keys.
    ```yaml
    spec:
      unsealer:
        ...
        mode:
          googleKmsGcs:
            bucket: <bucket_name>
            kmsProject: <project_name>
            kmsLocation: <location>
            kmsKeyRing: <key_ring_name>
            kmsCryptoKey: <crypto_key_name>
            credentialSecret: <secret_name>
    ```

    googleKmsGcs has following fields:
    - **bucket** (string): Specifies the name of the bucket to store keys in.
    - **kmsProject** (string): Specifies the name of the projects under which key ring is created.
    - **kmsLocation** (string): Specifies the location of the key ring. 
    - **kmsKeyRing** (string): Specifies the name of the key ring.
    - **kmsCryptoKey** (string): Specifies the name of the crypto key.
    - **credentialSecret** (string): Specifies the secret name containing google credential. If this is empty, then instance service account will be used. Google credential secret example:
      ```yaml
      apiVersion: v1
      data:
        sa.json: <data>
      kind: Secret
      metadata:
        name: google-credential
      ```
  <br></br>
  - **awsKmsSsm** : Unseal keys and root token will be stored in AWS System Manager Parameter store. They will be encrypted using AWS encryption key.
    ```yaml
    spec:
      unsealer:
        ...
        mode:
          awsKmsSsm:
            kmsKeyID: <key_id>
            region: <region>
            credentialSecret: <secret_name>
    ```
    awsKmsSsm has following fields:
    - **kmsKeyID** (string): The ID or ARN of the AWS KMS key to encrypt values.
    - **region** (string): Specifies the AWS region.
    - **credentialSecret** (string): Specifies the secret name containing AWS access key and AWS secret key. Credential secret example:
      ```yaml
      apiVersion: v1
      data:
        access_key: <base64_encoded_access_key>
        secret_key: <base64_encoded_secret_key>
      kind: Secret
      metadata:
        name: aws-credential
        namespaces: default
      ```
  <br></br>
  - **azureKeyVault** : Unseal keys and root token will be stored in Azure Key Vault as secret.
    ```yaml
    spec:
      unsealer:
        ...
        mode:
          azureKeyVault:
            vaultBaseUrl: <vault_base_url>
            tenantID: <tenant_id>
            clientCertSecret: <secret_name>
            aadClientSecret: <secret_name
            useManagedIdentity: <true/false>
            cloud: <cloud_environment_identifier>
    ```
    azureKeyVault has following field:
    - **vaultBaseUrl** (string): Specifies Azure key vault url.
    - **tenantID** (string): Specifies Azure Active Directory tenant ID.
    - **clientCertSecret** (string) : Specifies the name of secret containing client cert and client cert password.
      ```yaml
      apiVersion: v1
      data:
        client-cert: <client_cert>
        client-cert-password: <client_cert_password>
      kind: Secret
      metadata:
        name: azure-client-cert
        namespace: default
      ```
    - **addClientSecret** (string) : Specifies the name of secret containing client id and client secret of AAD application.
      ```yaml
      apiVersion: v1
      data:
        client-id: <client_id>
        client-secret: <client_secret>
      kind: Secret
      metadata:
        name: azure-client-secret
        namespace: default
      ```
    - **useManageIdentity** (bool): Use managed service identity for the virtual machine.
    - **cloud** (string): Specifies the the cloud environment identifier. If it is not provided then `AZUREPUBLICCLOUD` will be used as default.
    <br></br>
    > Note: unsealer will need `GET,LIST,SET` secret permissions to store or access unseal keys and root token.

## VaultServer Status

VaultServer Status shows the status of vault deployment. Status of vault are monitored and updated by vault operator.
```yaml
status:
  phase: <phase>
  initialized: <true/false>
  serviceName: <service_name>
  clientPort: <client_port>
  vaultStatus:
    active: <active_vault_pod_name>
    standby: <names_of_the_standby_vault_pod>
    sealed: <names_of_the_sealed_vault_pod>
    unsealed: <names_of_the_unsealed_vault_pod>
```
- **phase** : Indicates the phase vault is currently in.
- **initialized** : Indicates whether vault is initialized or not.
- **serviceName** : Name of the service by which vault can be accessed.
- **clientPort** : Indicates the port client will use to communicate with vault.
- **vaultStatus**: Indicates the status of vault pods.
  - **active**: Name of the active vault pod.
  - **standby**: Names of the standby vault pods.
  - **sealed**: Names of the sealed vault pods.
  - **unsealed**: Names of the unsealed vault pods.
  