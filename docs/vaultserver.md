# VaultServer CRD

Vault operator will deploy vault according to `VaultServer` CRD specification.

```yaml
apiVersion: "core.kubevault.com/v1alpha1"
kind: "VaultServer"
metadata:
  name: <name>
spec:
  ...
status:
  ...
```
### VaultServer Spec

VaultServer Spec contains the configuration about how to deploy vault in kubernetes cluster. 
```yaml
apiVersion: "core.kubevault.com/v1alpha1"
kind: "VaultServer"
metadata:
  name: <name>
spec:
  nodes: <num_of_nodes>
  baseImage: <base_image>
  version: <version>
  podPolicy:
    ...
  configMapName:
    ...
  backendStorage:
    ...
  unsealer:
    ...
```

- **nodes** (int): Number of vault nodes to deploy. For example, if `nodes:3`, then 3 vault server will be deployed in kubernetes cluster.

- **baseImage** (string): Base image to use for vault deployment. For example, `baseImage: vault`

- **version** (string): Version of vault image to be deployed. For example,
    ```yaml
    spec:
      baseImage: "vault"
      version: "0.10.0"
    ```
    here, `vault:0.10.0` image will be used to deploy vault.

- **podPolicy** (PodPolicy): PodPolicy defines the policy for pods. It contains resource requirements for the containers. For more information on `resources` see [here](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.10/#resourcerequirements-v1-core).
  ```yaml
  spec:
    podPolicy:
      resources:
        requests:
          cpu: "500m"
          memory: "1Gi"
   ```

- **configMapName** (string): Name of the configMap containing extra vault configuration. The configuration in the configMap will be **appended** to vault config generated by vault operator.
  ```yaml
  spec:
    configMapName: "vault-extra-config"
  ```
  configMap example:
  ```yaml
  apiVersion: v1
  data:
    vault.hcl: |
      telemetry {
      statsite_address = "statsite.company.local:8125"
      }
      ui = true
  kind: ConfigMap
  metadata:
    name: vault-extra-config
  ```

- **backendStorage** (BackendStorageSpec): It contains backend storage configuration for vault. See [here](vaultserver.md#backendstorage-spec) for more information.

- **unsealer** (UnsealerSpec): It contains auto unsealing configuration. See [here](vaultserver.md#unsealer-spec) for more information.

### BackendStorage Spec
BackendStorage Spec contains the information for vault storage backend. Vault operator generates storage configuration according to this spec.

- **inmem** (bool): To use In-Memory as storage backend in vault. For more information see [here](https://www.vaultproject.io/docs/configuration/storage/in-memory.html).
  ```yaml
  backendStorage:
    inmem: true
  ```

- **etcd** (EtcdSpec): Contain the information to use etcd as storage backend in vault.
  ```yaml
  backendStorage:
    etcd:
      address: "http://example.etcd.svc:8200"
      etcdApi: "v3"
  ```
  **EtcdSpec** contain following fields: 
    - **address** (string): Specifies the addresses of the etcd instances. For vault documentation, click [here](https://www.vaultproject.io/docs/configuration/storage/etcd.html#address).
    - **etcdApi** (string): Specifies the version of the API to communicate with etcd. For vault documentation, click [here](https://www.vaultproject.io/docs/configuration/storage/etcd.html#etcd_api).
    - **haEnable** (bool): Specifies if high availability should be enabled. For vault documentation, click [here](https://www.vaultproject.io/docs/configuration/storage/etcd.html#ha_enabled).
    - **path** (string):Specifies the path in etcd where vault data will be stored. For vault documentation, click [here](https://www.vaultproject.io/docs/configuration/storage/etcd.html#path).
    - **sync** (bool):Specifies whether to sync list of available etcd services on startup. For vault documentation, click [here](https://www.vaultproject.io/docs/configuration/storage/etcd.html#sync).
    - **discoverySrv** (string): Specifies the domain name to query for SRV records describing cluster endpoints. For vault documentation, click [here](https://www.vaultproject.io/docs/configuration/storage/etcd.html#discovery_srv).
    - **credentialSecretName** (string): Specifies the secret name that contain username and password to use when authenticating with the etcd server. For vault documentation, click [here](https://www.vaultproject.io/docs/configuration/storage/etcd.html#username).
  
      ```yaml
      backendStorage:
        etcd:
          credentialSecretName: "vault-etcd-credential"
          ...
      ```
      Credential secret example:
  
      ```yaml
      apiVersion: v1
      data:
        username: <username>
        password: <password>
      kind: Secret
      metadata:
        name: vault-etcd-credential
      ```
    
    - **tlsSecretName** (string): Specifies the secret name that contains ca cert, client cert and client key for etcd communication.For vault documentation, click [here](https://www.vaultproject.io/docs/configuration/storage/etcd.html#tls_ca_file).
  
      ```yaml
      backendStorage:
        etcd:
          tlsSecretName: "vault-etcd-tls"
          ...
      ```
      TLS secret example:
  
      ```yaml
      apiVersion: v1
      data:
        etcd-ca.crt: <ca_crt>
        etcd-client.crt: <client-crt>
        etcd-client.key: <client-key>
      kind: Secret
      metadata:
        name: vault-etcd-tls
      ```
- **gcs** (GcsSpec): Contain the informations to use gcs as backen storage in vault. Vault documention about gcs storage can be found [here](https://www.vaultproject.io/docs/configuration/storage/google-cloud-storage.html)
  ```yaml
  backendStorage:
    gcs:
      Bucket: <bucket_name>
      chunkSize: <chunk_size>
      maxParallel: <max_parallet>
      haEnabled: <true/false>
  ```
  **GcsSpec** has following fields:
    - **bucket** (string): Specifies the name of the bucket to use for storage.
    - **chunkSize** (string) : Specifies the maximum size (in kilobytes) to send in a single request. If set to 0, it will attempt to send the whole object at once, but will not retry any failures.
    - **maParallel** (int): Specifies the maximum number of parallel operations to take place.
    - **haEnabled** (bool) : Specifies if high availability mode is enabled.

### Unsealer Spec
Vault operator use [kubevault/unsealer](https://github.com/kubevault/unsealer) to unseal vault. Unsealer spec contains the informations that used in unsealer to unseal vault.

```yaml
spec:
  unsealer:
    secretShares: <num_of_secret_shares>
    secretThresold: <num_of_secret_threshold>
    retryPeriodSeconds: <retry_period>
    overwriteExisting: <true/false>
    insecureTLS: <true/false>
    vaultCASecret: <secret_name>
    mode:
      ...
```

- **secretShares** (int): Specifies the number of shares to split the master key into.

- **secretThreshold** (int): Specifies the number of keys required to unseal vault.

- **retryPeriodSeconds** (int): How often to attempt to unseal the vault instance.

- **overwriteExisting** (bool): To overwrite existing unseal keys and root token.

- **insecureTLS** (bool): To skip tls verification when unsealer communicating with vault server.

- **vaultCASecret** (string): Name of secret containing ca cert that will be used to verify vault server certificates when unsealer communication with it.
  ```yaml
  spec:
    unsealer:
      vaultCASecret: vault-ca-secret
      ...
  ```
  Vault ca secret example:
  ```yaml
  apiVersion: v1
  data:
    ca.crt: <ca crt>
  kind: Secret
  metadata:
    name: vault-ca-secret
  ```
- **mode**: Mode contains unseal mechanism. Currently available mechanism are:
  - **kubernetesSecret** : Unseal key and root token are stored in kubernetes secret. This secret is created by unsealer.
    ```yaml
    spec:
      unsealer:
        ...
        mode:
          kubernetesSecret:
            secretName: <secret_name>
    ```
    kubernetesSecret contains following fields:
      - **secretName** (string): Unsealer will create secret of this name.
  - **googleKmsGcs** : Unseal key and root token are stored in google cloud bucket and they are encrypted using google cryptographic keys.
    ```yaml
    spec:
      unsealer:
        ...
        mode:
          googleKmsGcs:
            bucket: <bucket_name>
            kmsProject: <project_name>
            kmsLocation: <location>
            kmsKeyRing: <key_ring_name>
            kmsCryptoKey: <crypto_key_name>
    ```

    googleKmsGcs has following fields:
    - **bucket** (string): Specifies the name of the bucket to store keys in.
    - **kmsProject** (string): Specifies the name of the projects under which key ring is created.
    - **kmsLocation** (string): Specifies the location of the key ring. 
    - **kmsKeyRing** (string): Specifies the name of the key ring.
    - **kmsCryptoKey** (string): Specifies the name of the crypto key.

## VaultServer Status

VaultServer Status shows the status of vault deployment. Status of vault are monitored and updated by vault operator.
```yaml
status:
  phase: <phase>
  initialized: <true/false>
  serviceName: <service_name>
  clientPort: <client_port>
  vaultStatus:
    active: <active_vault_pod_name>
    standby: <names_of_the_standby_vault_pod>
    sealed: <names_of_the_sealed_vault_pod>
    unsealed: <names_of_the_unsealed_vault_pod>
```
- **phase** : Indicates the phase vault is currently in.
- **initialized** : Indicates whether vault is initialized or not.
- **serviceName** : Name of the service by which vault can be accessed.
- **clientPort** : Indicates the port client will use to communicate with vault.
- **vaultStatus**: Indicates the status of vault pods.
  - **active**: Name of the active vault pod.
  - **standby**: Names of the standby vault pods.
  - **sealed**: Names of the sealed vault pods.
  - **unsealed**: Names of the unsealed vault pods.
  